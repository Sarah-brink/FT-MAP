<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI OBS map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
  html, body {
    height: 100%;
    margin: 0;
    background: #1A807D;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  #app {
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  #toolbar {
    padding: 10px 14px;
    background: #334267;
    color: #ffffff;
    display: flex;
    gap: 10px;
    align-items: center;
    border-bottom: 1px solid #1A807D;
    z-index: 5;
  }

  #toolbar label {
    font-size: 14px;
    opacity: 0.85;
  }

  #themeSelect {
    background: #111;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 14px;
  }

  /* Toggle Switch */
  .toggle-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  .toggle-group label {
    margin: 0;
    font-size: 13px;
  }

  .toggle-switch {
    display: inline-flex;
    background: rgba(255,255,255,0.15);
    border-radius: 20px;
    padding: 2px;
    gap: 0;
    border: 1px solid rgba(255,255,255,0.25);
  }

  .toggle-option {
    padding: 6px 12px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
    border-radius: 18px;
  }

  .toggle-option.active {
    background: #1A807D;
    color: #ffffff;
  }

  #themeDot {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.35);
    background: #ffffff;
  }

  #map {
    flex: 1;
    background: #1A807D;
    z-index: 1;
  }

  /* Hide Leaflet attribution */
  .leaflet-control-attribution { display: none; }

  /* =========================
     SIDE PANEL (replaces popup)
     ========================= */
  #infoPanel {
    position: absolute;
    top: 56px;               /* sits below toolbar */
    right: 14px;
    width: 420px;
    max-width: calc(100vw - 28px);
    max-height: calc(100vh - 80px);
    background: rgba(255,255,255,0.96);
    border-radius: 18px;
    box-shadow: 0 18px 50px rgba(0,0,0,0.25);
    overflow: hidden;
    display: none;           /* hidden until opened */
    z-index: 10;
    backdrop-filter: blur(6px);
  }

  #infoPanelHeader {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 14px 14px 12px 14px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.9);
  }

  #infoPanelTitle {
    font-weight: 700;
    font-size: 14px;
    color: #111;
    margin: 0;
    line-height: 1.2;
  }

  #infoPanelMeta {
    font-size: 12px;
    opacity: 0.75;
    margin-top: 2px;
  }

  #infoPanelBody {
    padding: 14px;
    overflow-y: scroll;  /* Always show scrollbar */
    max-height: 300px;
  }

  .panel-project {
    padding: 12px;
    margin-bottom: 12px;
    background: #f6f6f6;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .panel-project-title {
    font-weight: 800;
    font-size: 14px;
    margin: 0 0 6px 0;
    color: #111;
  }

  .panel-row {
    font-size: 13px;
    color: #111;
    margin: 2px 0;
  }

  .panel-row strong { font-weight: 700; }

  .theme-chips {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .theme-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.12);
    font-size: 12px;
    color: #111;
    white-space: nowrap;
  }

  .theme-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.35);
  }

  .panel-hint {
    font-size: 12px;
    opacity: 0.7;
    margin-top: 6px;
  }

  /* Hide the popup tip/arrow */
  .leaflet-popup-tip {
    display: none;
  }  

    /* Style popup wrapper */
  .leaflet-popup-content-wrapper {
    border-radius: 16px;
    overflow: hidden;
  }

  .leaflet-popup {
    border-radius: 16px;
  }  

  /* Scrollable section for extra projects */
  .scrollable-projects {
    max-height: 400px; /* Set a max height for the scrollable section */
    overflow-y: auto; /* Enable scrolling if there are more projects */
    padding-top: 10px;
  }

  .project-popup .leaflet-popup-content {
    margin: 0;
    width: 420px; /* Caps the width of the popup */
    max-height: 360px; /* Caps the height of the popup */
    overflow: auto; /* Manage overflow */
  }

  .project-popup .popup-header {
    padding: 14px 14px 10px 14px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.95);
  }

  .project-popup .popup-title {
    font-weight: 800;
    font-size: 16px;
    color: #111;
    line-height: 1.2;
  }

  .project-popup .popup-meta {
    font-size: 12px;
    opacity: 0.75;
    margin-top: 2px;
  }

  /* This is the popup body that holds the projects */
  .project-popup .popup-body {
    padding: 14px;
    max-height: 300px;
    overflow-y: scroll;   /* Always show scrollbar */
    overflow-x: hidden;
  }

  .project-popup .scrollable-projects {
    max-height: 200px;
    overflow-y: scroll;  /* Always show scrollbar */
    padding-top: 10px;
  }

  .project-button {
    display: inline-block;
    margin-top: 8px;
    padding: 8px 16px;
    background: #ffffff;
    color: ##1A807D;
    text-decoration: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    border: 1px solid #1A807D;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .project-button:hover {
    background: #156460;
    color: #ffffff;
  }

  /* Mobile: turn panel into bottom sheet */
  @media (max-width: 640px) {
    #infoPanel {
      left: 14px;
      right: 14px;
      width: auto;
      top: auto;
      bottom: 14px;
      max-height: 55vh;
    }
  }
  </style>

</head>

<body>
  <div id="app">
    <div id="toolbar">
      <label for="themeSelect">Explore by theme</label>
      <span id="themeDot" aria-hidden="true"></span>
      <select id="themeSelect"></select>
      <div class="toggle-group">
        <label>Status:</label>
        <div class="toggle-switch">
          <button class="toggle-option active" data-status="live">Live</button>
          <button class="toggle-option" data-status="all">All</button>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <!-- Side panel -->
    <div id="infoPanel" role="dialog" aria-modal="false" aria-label="Country projects panel">
      <div id="infoPanelHeader">
        <div>
          <div id="infoPanelTitle">Projects</div>
          <div id="infoPanelMeta"></div>
        </div>
      </div>
      <div id="infoPanelBody"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    window.addEventListener("load", () => {
      /* =========================
         PROJECT DATA
         ========================= */
      const projects = [
        {
          iso_a3: "BGD",
          country: "Bangladesh",
          projects: [
            {
              project: "Evidence for accountability: Remote sensing to protect the environment from harms",
              themes: ["Nature and Biodiversity"],
              pilot_status: "Live"
            },
            {
              project: "Applying data aggregator platform and distributed manufacturing technologies to meet",
              themes: ["Humanitarian"],
              pilot_status: "Closed"
            },
            {
              project: "Humanitarian Supplies on the Blockchain",
              themes: ["Humanitarian"],
              pilot_status: "Closed"
            }
          ]
        },
        {
          iso_a3: "BRA",
          country: "Brazil",
          projects: [
            {
              project: "Stop the spread: Using drones and nano-bio gel to prevent wildfires",
              themes: ["Nature and Biodiversity"],
              pilot_status: "Live"
            }
          ]
        },
        {
          iso_a3: "KEN",
          country: "Kenya",
          projects: [
            {
              project: "Data for matchmaking: Connecting start-ups and funders",
              themes: ["Sustainable Economic Development"],
              pilot_status: "Live",
              url: "https://www.frontiertechhub.org/pilot-portfolio/unlocking-innovation"
            },
            {
              project: "Smart mobility: using assistive tech and digital mapping to promote urban accessibility",
              themes: ["Infrastructure and Energy"],
              pilot_status: "Live"
            },
            {
              project: "Solar Home electrolyser proof of concept",
              themes: ["Infrastructure and Energy"],
              pilot_status: "Closed"
            },
            {
              project: "Low-cost sensors for optimal insect protein production",
              themes: ["Agriculture and Food Security"],
              pilot_status: "Closed"
            },
            {
              project: "Portable Benefits and Protections Platform",
              themes: ["Other"],
              pilot_status: "Closed"
            },
            {
              project: "Kijenzi - Manufacturing for the next frontier",
              themes: ["Sustainable Economic Development"],
              pilot_status: "Closed"
            },
            {
              project: "Smart Contraceptive Vending Machines",
              themes: ["Global Health"],
              pilot_status: "Closed"
            },
            {
              project: "EVs and Mini-Grids",
              themes: ["Infrastructure and Energy"],
              pilot_status: "Closed"
            },
            {
              project: "Monitoring biodiversity with frontier sensing technologies",
              themes: ["Nature and Biodiversity"],
              pilot_status: "Closed"
            }
          ]
        }
      ];

      const projectByIso = new Map(
        projects.map(p => [String(p.iso_a3).trim().toUpperCase(), p])
      );

      /* =========================
         THEME COLOURS
         ========================= */
      const themeColors = {
        "Nature & Biodiversity": "#2f9e44",
        "Humanitarian": "#f08c00",
        "Sustainable Economic Development": "#51cf66",
        "Infrastructure and Energy": "#4dabf7",
        "Global Health": "#ff4d6d",
        "Agriculture and Food Security": "#47eafc",
        "Nature and Biodiversity": "#01f9c6",
        "Other": "#ccc"
      };

      const defaultColor = "#ffffff";

      /* =========================
         THEME DROPDOWN + DOT
         ========================= */
      const themes = Array.from(
        new Set(projects.flatMap(p => p.projects.flatMap(proj => proj.themes)))
      ).sort();

      const themeSelect = document.getElementById("themeSelect");
      const themeDot = document.getElementById("themeDot");

      // Status toggle
      let statusFilter = "live"; // "live" or "all"
      const toggleButtons = document.querySelectorAll(".toggle-option");
      toggleButtons.forEach(btn => {
        btn.addEventListener("click", (e) => {
          toggleButtons.forEach(b => b.classList.remove("active"));
          e.target.classList.add("active");
          statusFilter = e.target.dataset.status;
          if (geoLayer) geoLayer.setStyle(regionStyle);
          updateThemeDot();
        });
      });

      themeSelect.innerHTML = "";

      const allOpt = document.createElement("option");
      allOpt.value = "__ALL__";
      allOpt.textContent = "All projects";
      themeSelect.appendChild(allOpt);

      for (const t of themes) {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        themeSelect.appendChild(opt);
      }

      function currentThemeColor() {
        const selected = themeSelect.value;
        if (selected === "__ALL__") return defaultColor;
        return themeColors[selected] || defaultColor;
      }

      function updateThemeDot() {
        if (!themeDot) return;
        themeDot.style.background = currentThemeColor();
      }

      updateThemeDot();

      /* =========================
         MAP SETUP (NO BASEMAP)
         ========================= */
      const map = L.map("map", {
        zoomControl: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        touchZoom: true,
        dragging: true,
        zoomSnap: 0.5
      }).setView([15, 15], 2);

      map.zoomControl.setPosition("topright");

      const hoverPopup = L.popup({
        autoPan: true,
        closeButton: false,
        className: "project-popup"
      });

      function buildPopupHTML(countryProjects) {
        const selectedTheme = themeSelect.value;

        const filtered = countryProjects.projects.filter(proj => {
          const themeMatch = selectedTheme === "__ALL__" || (proj.themes || []).includes(selectedTheme);
          const statusMatch = statusFilter === "all" || proj.pilot_status === "Live";
          return themeMatch && statusMatch;
        });

        if (filtered.length === 0) return "";

        const displayed = filtered.slice(0, 3);
        const extra = filtered.slice(3);

        return `
          <div class="popup-wrap">
            <div class="popup-header">
              <div class="popup-title">${countryProjects.country}</div>
              <div class="popup-meta">${filtered.length} project${filtered.length === 1 ? "" : "s"}</div>
            </div>

            <div class="popup-body">
              ${displayed.map(proj => `
                <div class="panel-project">
                  <div class="panel-project-title">${proj.project}</div>
                  <div class="panel-row"><strong>Pilot Status:</strong> ${proj.pilot_status || "-"}</div>
                  ${renderThemeChips(proj.themes)}
                  ${proj.url ? `<a href="${proj.url}" class="project-button" target="_blank">Learn more</a>` : ""}
                </div>
              `).join("")}

              ${extra.length > 0 ? `
                <div class="panel-hint">Scroll for more projects.</div>
                <div class="scrollable-projects">
                  ${extra.map(proj => `
                    <div class="panel-project">
                      <div class="panel-project-title">${proj.project}</div>
                      <div class="panel-row"><strong>Pilot Status:</strong> ${proj.pilot_status || "-"}</div>
                      ${renderThemeChips(proj.themes)}
                      ${proj.url ? `<a href="${proj.url}" class="project-button" target="_blank">Learn more</a>` : ""}
                    </div>
                  `).join("")}
                </div>
              ` : ""}
            </div>
          </div>
        `;
      }

      /* =========================
         HELPERS
         ========================= */
      function isActiveTheme(projectList, selectedTheme) {
        if (!projectList) return false;
        if (selectedTheme === "__ALL__") return true;
        return projectList.some(p => (p.themes || []).includes(selectedTheme));
      }

      function getIsoFromFeature(feature) {
        const props = feature?.properties || {};
        const iso =
          props.ADM0_A3 ?? props.ISO_A3 ?? props.iso_a3 ?? props.ISO3 ?? props.id ?? "";
        return String(iso).trim().toUpperCase();
      }

      function renderThemeChips(themeList) {
        return `
          <div class="theme-chips">
            ${(themeList || []).map(t => {
              const c = themeColors[t] || defaultColor;
              return `
                <span class="theme-chip">
                  <span class="theme-dot" style="background:${c}"></span>
                  ${t}
                </span>
              `;
            }).join("")}
          </div>
        `;
      }

      function regionStyle(feature) {
        const iso = getIsoFromFeature(feature);
        const countryProjects = projectByIso.get(iso);
        const selected = themeSelect.value;

        const base = {
          color: "#ffffff",
          weight: 0.8,
          opacity: 0.35,
          fillOpacity: 0
        };

        if (!countryProjects) return base;

        const active = isActiveTheme(countryProjects.projects, selected);
        if (!active) return base;

        const fill = selected === "__ALL__"
          ? defaultColor
          : (themeColors[selected] || defaultColor);

        return {
          ...base,
          opacity: 0.95,
          weight: 1.4,
          fillColor: fill,
          fillOpacity: 0.55
        };
      }

      /* =========================
         SIDE PANEL LOGIC
         ========================= */
      const infoPanel = document.getElementById("infoPanel");
      const infoPanelTitle = document.getElementById("infoPanelTitle");
      const infoPanelMeta = document.getElementById("infoPanelMeta");
      const infoPanelBody = document.getElementById("infoPanelBody");

      function openPanel(countryProjects, latlng) {
        if (!countryProjects.projects || countryProjects.projects.length === 0) {
          closePanel();
          return;
        }

        infoPanelTitle.textContent = countryProjects.country;
        infoPanelMeta.textContent = `${countryProjects.projects.length} project${countryProjects.projects.length === 1 ? "" : "s"}`;

        const filteredProjects = countryProjects.projects.filter(proj => {
          const themeMatch = themeSelect.value === "__ALL__" || proj.themes.includes(themeSelect.value);
          const statusMatch = statusFilter === "all" || proj.pilot_status === "Live";
          return themeMatch && statusMatch;
        });

        const displayedProjects = filteredProjects.slice(0, 3);
        const extraProjects = filteredProjects.slice(3);

        infoPanelBody.innerHTML = `
          ${displayedProjects.map(proj => `
            <div class="panel-project">
              <div class="panel-project-title">${proj.project}</div>
              <div class="panel-row"><strong>Pilot Status:</strong> ${proj.pilot_status || "-"}</div>
              ${renderThemeChips(proj.themes)}
              ${proj.url ? `<a href="${proj.url}" class="project-button" target="_blank">Learn more</a>` : ""}
            </div>
          `).join("")}

          ${extraProjects.length > 0 ? `
            <div class="panel-hint">Scroll for more projects.</div>
            <div class="scrollable-projects">
              ${extraProjects.map(proj => `
                <div class="panel-project">
                  <div class="panel-project-title">${proj.project}</div>
                  <div class="panel-row"><strong>Pilot Status:</strong> ${proj.pilot_status || "-"}</div>
                  ${renderThemeChips(proj.themes)}
                  ${proj.url ? `<a href="${proj.url}" class="project-button" target="_blank">Learn more</a>` : ""}
                </div>
              `).join("")}
            </div>
          ` : ''}
        `;

        infoPanel.style.display = "block";
      }

      function closePanel() {
        infoPanel.style.display = "none";
        infoPanelTitle.textContent = "Projects";
        infoPanelMeta.textContent = "";
        infoPanelBody.innerHTML = "";
      }

      /* =========================
         LOAD GEOJSON + INTERACTION
         ========================= */
      let geoLayer = null;

      const GEOJSON_URL =
        "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_110m_admin_0_countries.geojson";

      async function init() {
        let geojson;
        try {
          const res = await fetch(GEOJSON_URL);
          if (!res.ok) throw new Error(`GeoJSON fetch failed: ${res.status} ${res.statusText}`);
          geojson = await res.json();
        } catch (e) {
          console.error("Error fetching GeoJSON", e);
          alert("Could not load country boundaries (GeoJSON). Check the console for details.");
          return;
        }

        geoLayer = L.geoJSON(geojson, {
          style: regionStyle,
          onEachFeature: (feature, layer) => {
            const iso = getIsoFromFeature(feature);
            const countryProjects = projectByIso.get(iso);
            if (!countryProjects) return;

            layer.on("mouseover", (e) => {
              const countryProjects = projectByIso.get(getIsoFromFeature(e.target.feature));
              if (!countryProjects) return;

              const html = buildPopupHTML(countryProjects);
              if (!html) return;

              hoverPopup
                .setLatLng(e.latlng)
                .setContent(html)
                .openOn(map);
            });

            layer.on("mouseout", (e) => {
              const related = e && e.originalEvent && e.originalEvent.relatedTarget;
              if (related && related.closest && related.closest('.project-popup')) {
                return;
              }
              map.closePopup(hoverPopup);
            });

            map.on('click', () => map.closePopup(hoverPopup));
          }
        }).addTo(map);

        const bounds = [];
        geoLayer.eachLayer(l => {
          const iso = getIsoFromFeature(l.feature);
          if (projectByIso.has(iso)) bounds.push(l.getBounds());
        });

        if (bounds.length) {
          const combined = bounds.reduce((acc, b) => acc.extend(b), bounds[0]);
          map.fitBounds(combined.pad(0.3));
        }
      }

      // Stop wheel/touch from bubbling to the map so the popup body can scroll
      map.on('popupopen', (e) => {
        const el = e.popup.getElement && e.popup.getElement();
        const content = el && el.querySelector('.popup-body');
        if (!content) return;

        const stop = (ev) => ev.stopPropagation();

        content.addEventListener('wheel', stop, { passive: false });
        content.addEventListener('touchstart', stop, { passive: false });
        content.addEventListener('touchmove', stop, { passive: false });

        const disableDragging = () => map.dragging.disable();
        const enableDragging = () => map.dragging.enable();

        content.addEventListener('mouseenter', disableDragging);
        content.addEventListener('mouseleave', enableDragging);
        content.addEventListener('touchstart', disableDragging, { passive: false });
        content.addEventListener('touchend', enableDragging, { passive: false });

        e.popup._cleanupScroll = () => {
          content.removeEventListener('wheel', stop);
          content.removeEventListener('touchstart', stop);
          content.removeEventListener('touchmove', stop);
          content.removeEventListener('mouseenter', disableDragging);
          content.removeEventListener('mouseleave', enableDragging);
          content.removeEventListener('touchstart', disableDragging);
          content.removeEventListener('touchend', enableDragging);
        };
      });

      map.on('popupclose', (e) => {
        if (e.popup && e.popup._cleanupScroll) e.popup._cleanupScroll();
      });

      themeSelect.addEventListener("change", () => {
        updateThemeDot();
        if (geoLayer) geoLayer.setStyle(regionStyle);
      });

      init();
    });
  </script>
</body>
</html>
